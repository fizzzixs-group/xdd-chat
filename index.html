<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XDD Chat: Liquid Glass Messenger</title>
    <style>
        /* CSS3 Styles: Liquid Glass (Glassmorphism + Neumorphism) */
        :root {
            /* Light Theme Variables */
            --bg-color-light: #f0f0f5;
            --text-color-light: #1a1a2e;
            --accent-color-light: #4a4e69;
            --light-shadow-light: #ffffff;
            --dark-shadow-light: #b0b0b5;
            --glass-bg-light: rgba(255, 255, 255, 0.5);
            --chat-bubble-self-light: #4a4e69;
            --chat-bubble-other-light: #c9c7d4;
            
            /* Dark Theme Variables (Default) */
            --bg-color-dark: #1a1a2e;
            --text-color-dark: #f0f0f5;
            --accent-color-dark: #a9a9a9;
            --light-shadow-dark: #2c2c54;
            --dark-shadow-dark: #0e0e1a;
            --glass-bg-dark: rgba(44, 44, 84, 0.6);
            --chat-bubble-self-dark: #a9a9a9;
            --chat-bubble-other-dark: #4a4e69;

            /* Contrast Theme Variables */
            --bg-color-contrast: #000000;
            --text-color-contrast: #ffffff;
            --accent-color-contrast: #00ff00;
            --light-shadow-contrast: #333333;
            --dark-shadow-contrast: #000000;
            --glass-bg-contrast: rgba(0, 0, 0, 0.7);
            --chat-bubble-self-contrast: #00ff00;
            --chat-bubble-other-contrast: #333333;
            
            /* General Variables (Default to Dark Theme) */
            --bg-color: var(--bg-color-dark);
            --text-color: var(--text-color-dark);
            --accent-color: var(--accent-color-dark);
            --light-shadow: var(--light-shadow-dark);
            --dark-shadow: var(--dark-shadow-dark);
            --glass-bg: var(--glass-bg-dark);
            --chat-bubble-self: var(--chat-bubble-self-dark);
            --chat-bubble-other: var(--chat-bubble-other-dark);
            
            --chat-text-self: var(--bg-color); 
            --chat-text-other: var(--text-color);
            --glass-blur: blur(10px);
            
            --error-color: #e71d36;
            --premium-color: #ffd700;
            --verified-color: #1e90ff; 
            --online-color: #38b000;
            --font-size-small: 0.85rem;
            --font-size-standard: 1rem;
            --font-size-large: 1.15rem;
        }

        /* --- Theme Switching Logic --- */
        body.light-theme {
            --bg-color: var(--bg-color-light);
            --text-color: var(--text-color-light);
            --accent-color: var(--accent-color-light);
            --light-shadow: var(--light-shadow-light);
            --dark-shadow: var(--dark-shadow-light);
            --glass-bg: var(--glass-bg-light);
            --chat-bubble-self: var(--chat-bubble-self-light);
            --chat-bubble-other: var(--chat-bubble-other-light);
            --chat-text-self: var(--bg-color-light);
            --chat-text-other: var(--text-color-light);
        }

        body.contrast-theme {
            --bg-color: var(--bg-color-contrast);
            --text-color: var(--text-color-contrast);
            --accent-color: var(--accent-color-contrast);
            --light-shadow: var(--light-shadow-contrast);
            --dark-shadow: var(--dark-shadow-contrast);
            --glass-bg: var(--glass-bg-contrast);
            --chat-bubble-self: var(--chat-bubble-self-contrast);
            --chat-bubble-other: var(--chat-bubble-other-contrast);
            --chat-text-self: var(--bg-color-contrast);
            --chat-text-other: var(--text-color-contrast);
        }
        
        /* Ensure dark theme is the initial base */
        body.dark-theme {
            --bg-color: var(--bg-color-dark);
            --text-color: var(--text-color-dark);
            --accent-color: var(--accent-color-dark);
            --light-shadow: var(--light-shadow-dark);
            --dark-shadow: var(--dark-shadow-dark);
            --glass-bg: var(--glass-bg-dark);
            --chat-bubble-self: var(--chat-bubble-self-dark);
            --chat-bubble-other: var(--chat-bubble-other-dark);
            --chat-text-self: var(--text-color-dark);
            --chat-text-other: var(--text-color-dark);
        }
        
        /* --- General Reset & Base Styles --- */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            /* Use slightly faster transitions for better feel */
            transition: color 0.3s ease, background-color 0.3s ease, box-shadow 0.3s ease, filter 0.3s ease;
        }

        body {
            min-height: 100vh;
            background-color: var(--bg-color);
            color: var(--text-color);
            padding: 20px;
        }

        .center-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 90vh;
        }

        /* --- Loading Screen Styles --- */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-color);
            z-index: 2000;
            flex-direction: column;
            gap: 20px;
        }

        .loader {
            font-size: 3rem;
            font-weight: bold;
            display: flex;
        }

        .letter {
            animation: bounce 1.2s infinite alternate;
            animation-delay: calc(var(--i) * 0.1s);
            color: var(--accent-color);
            text-shadow: 0 0 5px var(--accent-color);
        }

        @keyframes bounce {
            0% { transform: translateY(0); }
            100% { transform: translateY(-20px); filter: brightness(1.5); }
        }

        /* --- Glassmorphism Styles --- */
        .glass-container {
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border-radius: 24px;
            box-shadow: 
                8px 8px 16px var(--dark-shadow),
                -8px -8px 16px var(--light-shadow);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 30px;
        }

        /* --- Neumorphism & Interactive Elements --- */
        .neu-button, .neu-input, select.neu-input {
            border: none;
            outline: none;
            background: var(--bg-color);
            color: var(--text-color);
            border-radius: 18px;
            padding: 12px 25px;
            cursor: pointer;
            box-shadow: 
                4px 4px 8px var(--dark-shadow),
                -4px -4px 8px var(--light-shadow);
            transition: all 0.3s ease-in-out;
            font-size: 1rem;
        }
        
        .neu-button:active, 
        .neu-input:focus, 
        select.neu-input:focus {
            box-shadow: 
                inset 3px 3px 7px var(--dark-shadow),
                inset -3px -3px 7px var(--light-shadow);
            background-color: var(--bg-color);
        }

        .neu-button:hover:not(:active) {
            filter: brightness(1.2);
        }

        .icon-button {
            width: 50px;
            height: 50px;
            padding: 0;
        }

        .text-button {
            background: none;
            border: none;
            color: var(--accent-color);
            cursor: pointer;
            padding: 5px;
            transition: color 0.3s ease;
        }

        .accent-button {
            background-color: var(--accent-color);
            color: var(--bg-color);
        }

        .red-button {
            background-color: var(--error-color);
            color: var(--text-color);
        }

        /* --- Auth Page Styles --- */
        .auth-box {
            width: 400px;
            gap: 20px;
        }
        
        .logo-title {
            color: var(--accent-color);
            font-size: 2.5rem;
            margin-bottom: 5px;
            text-shadow: 0 0 5px var(--verified-color);
        }
        
        .auth-box form {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .error-message {
            color: var(--error-color);
            text-align: center;
            height: 1.5em;
        }

        /* --- Main App Layout --- */
        #main-app {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 40px);
            max-width: 1400px;
            margin: 0 auto;
        }

        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .main-content-flex {
            display: flex;
            flex-grow: 1;
            gap: 30px;
            min-height: 0;
        }

        .chat-list-container {
            flex-basis: 350px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            max-height: 100%;
            padding: 20px;
        }

        #chats-list {
            flex-grow: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding-right: 5px;
        }
        
        .chat-card {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            border-radius: 18px;
            cursor: pointer;
            background: var(--bg-color);
            box-shadow: 
                4px 4px 8px var(--dark-shadow),
                -4px -4px 8px var(--light-shadow);
        }

        .chat-card.active {
            box-shadow: 
                inset 3px 3px 7px var(--dark-shadow),
                inset -3px -3px 7px var(--light-shadow);
            background: var(--glass-bg);
            filter: brightness(1.1);
        }
        
        /* Icons */
        .premium-icon { color: var(--premium-color); margin-left: 5px; }
        .verified-icon { color: var(--verified-color); margin-left: 5px; }


        /* --- Chat Window Styles --- */
        #active-chat-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            min-height: 0;
        }

        #chat-header {
            display: flex;
            align-items: center;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            margin-bottom: 15px;
        }
        
        .online-dot {
            width: 10px;
            height: 10px;
            background-color: var(--online-color);
            border-radius: 50%;
            margin-left: 10px;
            display: inline-block;
        }

        #messages-container {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .message-bubble {
            max-width: 70%;
            padding: 12px 20px;
            border-radius: 25px;
            line-height: 1.4;
            transition: font-size 0.3s ease-in-out;
            font-size: var(--font-size-standard);
        }

        .message-self {
            align-self: flex-end;
            background-color: var(--chat-bubble-self);
            color: var(--chat-text-self);
        }

        .message-other {
            align-self: flex-start;
            background-color: var(--chat-bubble-other);
            color: var(--chat-text-other);
        }

        #message-input-area {
            display: flex;
            padding-top: 15px;
            gap: 10px;
        }

        #message-input {
            flex-grow: 1;
        }
        
        /* --- Modal Styles --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            width: 90%;
            max-width: 600px;
            gap: 20px;
        }
        
        .settings-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 15px 0;
            border-bottom: 1px dashed rgba(255, 255, 255, 0.1);
        }
        
        .profile-info .info-line {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
        }

        .privacy-section {
            flex-direction: row;
            align-items: center;
            justify-content: space-between;
        }

        .privacy-section span {
            flex-grow: 1;
            margin-left: 15px;
        }

        .action-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .action-group input, .action-group select {
            flex-basis: 150px;
            flex-grow: 1;
        }
        
        /* Toast Notification */
        #notification-toast {
            visibility: hidden;
            min-width: 250px;
            background-color: var(--accent-color);
            color: var(--bg-color);
            text-align: center;
            border-radius: 10px;
            padding: 16px;
            position: fixed;
            z-index: 1;
            right: 30px;
            bottom: 30px;
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2);
            opacity: 0;
            transition: opacity 0.5s, visibility 0.5s, bottom 0.5s;
        }
        #notification-toast.show {
            visibility: visible;
            opacity: 1;
            bottom: 40px;
        }

        /* Admin Trigger */
        #admin-panel-trigger {
            position: fixed;
            bottom: 0;
            right: 0;
            width: 16px;
            height: 16px;
            background-color: rgba(0, 0, 0, 0.05); 
            cursor: pointer;
            z-index: 999;
            border-top-left-radius: 5px;
        }
        
    </style>
</head>
<body class="dark-theme">

    <div id="loading-screen" class="center-container loading-screen">
        <div class="loader">
            <div class="letter" style="--i:1;">X</div>
            <div class="letter" style="--i:2;">D</div>
            <div class="letter" style="--i:3;">D</div>
            <div class="letter" style="--i:4;">&nbsp;</div>
            <div class="letter" style="--i:5;">C</div>
            <div class="letter" style="--i:6;">H</div>
            <div class="letter" style="--i:7;">A</div>
            <div class="letter" style="--i:8;">T</div>
        </div>
        <p>Loading the Liquid Glass Interface...</p>
    </div>

    <div id="auth-page" class="center-container" style="display: none;">
        <div class="glass-container auth-box">
            <h1 class="logo-title">XDD Chat</h1>
            <h2 id="auth-title">Log In</h2>
            <form id="auth-form">
                <input type="text" id="auth-username" placeholder="Username" required class="neu-input">
                <input type="email" id="auth-email" placeholder="Email (Registration Only)" style="display: none;" class="neu-input">
                <input type="password" id="auth-password" placeholder="Password" required class="neu-input">
                <p id="auth-error" class="error-message"></p>
                <button type="submit" id="auth-submit-btn" class="neu-button accent-button">Log In</button>
            </form>
            <button id="toggle-auth-btn" class="text-button">Don't have an account? Sign Up</button>
        </div>
    </div>

    <div id="main-app" style="display: none;">
        <header class="app-header">
            <div id="current-user-info">
                <span id="user-avatar">üßë</span>
                <span id="user-display-name"></span>
            </div>
            <button id="open-settings-btn" class="neu-button icon-button" title="Settings">‚öôÔ∏è</button>
        </header>

        <div class="main-content-flex">
            <div class="chat-list-container glass-container">
                <input type="text" id="chat-search-input" placeholder="üîç Search Chats..." class="neu-input">
                <div id="chats-list">
                    </div>
            </div>

            <div id="active-chat-container" class="glass-container">
                <div id="chat-header">
                    <h3 id="chat-partner-name"></h3>
                    <span id="chat-online-status" class="online-dot" title="Online"></span>
                </div>
                <div id="messages-container">
                    <p style="text-align: center; color: var(--accent-color); margin-top: 50px;">Select a chat to start messaging.</p>
                </div>
                <div id="message-input-area">
                    <input type="text" id="message-input" placeholder="Type a message..." class="neu-input">
                    <button id="send-message-btn" class="neu-button icon-button accent-button" title="Send">‚úâÔ∏è</button>
                </div>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content glass-container">
            <div class="modal-header">
                <h2>Profile Settings</h2>
                <button id="close-settings-btn" class="text-button icon-button">‚úñÔ∏è</button>
            </div>
            
            <div class="settings-section profile-info">
                <h3>Your Profile</h3>
                <div class="info-line">
                    <strong>Username:</strong> <span id="settings-username-display"></span>
                </div>
                <div class="info-line">
                    <strong>Email:</strong> <span id="settings-email-display"></span>
                </div>
                <div class="info-line">
                    <strong>Status:</strong> <span id="settings-status-display"></span>
                </div>
            </div>

            <div class="settings-section">
                <h3>üí∞ XDD Coin & Premium</h3>
                <div id="coin-balance-display">Balance: <span id="xdd-balance-value">0</span> XDD Coin</div>
                <div class="action-group">
                    <button data-amount="100" class="buy-coin-btn neu-button">+100 Coin</button>
                    <button data-amount="500" class="buy-coin-btn neu-button">+500 Coin</button>
                </div>
                <button id="buy-premium-btn" class="neu-button accent-button">Buy Premium (999 XDD Coin)</button>
            </div>
            
            <div class="settings-section">
                <h3>üé® Themes</h3>
                <div class="action-group">
                    <button data-theme="light" class="theme-btn neu-button">Light</button>
                    <button data-theme="dark" class="theme-btn neu-button accent-button">Dark</button>
                    <button data-theme="contrast" class="theme-btn neu-button">Contrast</button>
                </div>
            </div>

            <div class="settings-section">
                <h3>üí¨ Message Size</h3>
                <div class="action-group message-size-control">
                    <label>
                        <input type="radio" name="message-size" value="small"> Small
                    </label>
                    <label>
                        <input type="radio" name="message-size" value="standard" checked> Standard
                    </label>
                    <label>
                        <input type="radio" name="message-size" value="large"> Large
                    </label>
                </div>
            </div>

            <div class="settings-section privacy-section">
                <span>Show Online Status</span>
                <label class="switch">
                    <input type="checkbox" id="online-status-toggle" checked>
                    <span class="slider round"></span>
                </label>
            </div>

            <button id="logout-btn" class="neu-button red-button">Log Out</button>
        </div>
    </div>

    <div id="admin-panel-trigger"></div>

    <div id="admin-login-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content glass-container" style="max-width: 400px;">
            <div class="modal-header">
                <h2>Admin Login</h2>
                <button id="close-admin-login-btn" class="text-button icon-button">‚úñÔ∏è</button>
            </div>
            <input type="password" id="admin-password-input" placeholder="Enter Password" class="neu-input">
            <button id="admin-login-btn" class="neu-button accent-button">Log In</button>
        </div>
    </div>

    <div id="admin-panel-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content glass-container" style="max-width: 800px;">
            <div class="modal-header">
                <h2>üëë Admin Panel</h2>
                <button id="close-admin-panel-btn" class="text-button icon-button">‚úñÔ∏è</button>
            </div>
            
            <div class="settings-section">
                <h3>User Management</h3>
                <select id="admin-user-select" class="neu-input"></select>
                <div id="admin-user-details"></div>
            </div>
            
            <div class="settings-section action-group">
                <button id="admin-verify-btn" class="neu-button accent-button">Toggle Verification üîπ</button>
            </div>

            <div class="settings-section action-group">
                <h3>Award XDD Coin</h3>
                <input type="number" id="admin-coin-amount" placeholder="Amount" min="1" class="neu-input">
                <button id="admin-award-coin-btn" class="neu-button">Award Coin</button>
            </div>

            <div class="settings-section action-group">
                <h3>Temporary Ban</h3>
                <select id="admin-ban-duration" class="neu-input">
                    <option value="1">1 Hour</option>
                    <option value="24">1 Day</option>
                    <option value="168">7 Days</option>
                </select>
                <button id="admin-ban-btn" class="neu-button red-button">Ban User</button>
            </div>

            <div class="settings-section">
                <h3>Support Team Requests</h3>
                <div id="support-requests-list"></div>
            </div>
        </div>
    </div>

    <div id="notification-toast" class="toast"></div>

    <script>
        // JS Logic: Backend Simulation and State Management
        
        // --- Configuration & Data Simulation ---
        const VERIFIED_ICON = 'üîπ'; 
        const PREMIUM_ICON = 'üëë';
        const SUPPORT_NAME = 'Support Team';

        const userData = {
            users: [
                { id: 1, email: 'support@xdd.chat', username: SUPPORT_NAME, password: '1', isVerified: true, isPremium: true, xddCoinBalance: 99999, chats: [1] },
                { id: 2, email: 'test@mail.com', username: 'TestUser', password: '1', isVerified: false, isPremium: false, xddCoinBalance: 500, chats: [1] }
            ],
            currentUser: null, 
            chats: [
                { 
                    id: 1, 
                    participants: [SUPPORT_NAME, 'TestUser'], 
                    messages: [
                        { sender: SUPPORT_NAME, text: 'Welcome to XDD Chat! We are always ready to help.', timestamp: Date.now() - 3600000 }
                    ]
                }
            ],
            nextUserId: 3,
            nextChatId: 2,
            activeChatId: null,
            chatMessageSize: 'standard', 
            isOnlineVisible: true
        };

        // --- Utility Functions ---
        function getUserById(id) {
            return userData.users.find(u => u.id === id);
        }

        function getUserByUsername(username) {
            return userData.users.find(u => u.username === username);
        }

        function getChatById(id) {
            return userData.chats.find(c => c.id === id);
        }

        function getChatPartner(chat, currentUsername) {
            return chat.participants.find(p => p !== currentUsername);
        }

        function showNotification(message, duration = 3000) {
            const toast = document.getElementById('notification-toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }
        
        function validateUsername(username) {
            const regex = /^[a-zA-Z0-9]+$/;
            if (username.length < 5 || username.length > 16) {
                return 'Length must be between 5 and 16 characters.';
            }
            if (!regex.test(username)) {
                return 'Only Latin letters and digits are allowed.';
            }
            return '';
        }

        // --- Theme Management ---
        function applyTheme(theme) {
            document.body.classList.remove('light-theme', 'dark-theme', 'contrast-theme');
            if (theme !== 'light') {
                document.body.classList.add(`${theme}-theme`);
            } else {
                document.body.classList.add(`light-theme`);
            }
            // Update button styles to reflect active theme
            document.querySelectorAll('.theme-btn').forEach(btn => {
                if (btn.getAttribute('data-theme') === theme) {
                    btn.classList.add('accent-button');
                } else {
                    btn.classList.remove('accent-button');
                }
            });
        }
        
        // --- Rendering UI ---
        
        function updateUserInfoUI() {
            if (!userData.currentUser) return;

            const nameEl = document.getElementById('user-display-name');
            const balanceEl = document.getElementById('xdd-balance-value');
            
            const premiumIcon = userData.currentUser.isPremium ? ` <span class="premium-icon">${PREMIUM_ICON}</span>` : '';
            const verifiedIcon = userData.currentUser.isVerified ? ` <span class="verified-icon">${VERIFIED_ICON}</span>` : '';
            
            nameEl.innerHTML = `${userData.currentUser.username}${verifiedIcon}${premiumIcon}`;
            balanceEl.textContent = userData.currentUser.xddCoinBalance;
            
            // Update Settings Profile Info
            document.getElementById('settings-username-display').textContent = userData.currentUser.username;
            document.getElementById('settings-email-display').textContent = userData.currentUser.email;
            
            let status = 'Standard User';
            if (userData.currentUser.isPremium) status = `${PREMIUM_ICON} Premium User`;
            if (userData.currentUser.isVerified) status += ` / ${VERIFIED_ICON} Verified`;
            document.getElementById('settings-status-display').innerHTML = status;


            // Update Premium Button
            const buyPremiumBtn = document.getElementById('buy-premium-btn');
            if (userData.currentUser.isPremium) {
                buyPremiumBtn.textContent = 'Premium Active ‚úîÔ∏è';
                buyPremiumBtn.disabled = true;
                buyPremiumBtn.classList.remove('accent-button');
                buyPremiumBtn.style.cursor = 'default';
            } else {
                buyPremiumBtn.textContent = 'Buy Premium (999 XDD Coin)';
                buyPremiumBtn.disabled = false;
                buyPremiumBtn.classList.add('accent-button');
                buyPremiumBtn.style.cursor = 'pointer';
            }
        }
        
        function renderChatList() {
            const chatListEl = document.getElementById('chats-list');
            chatListEl.innerHTML = '';
            
            if (!userData.currentUser) return;

            const userChatIds = userData.currentUser.chats;
            const searchTerm = document.getElementById('chat-search-input').value.toLowerCase();
            
            userChatIds.forEach(chatId => {
                const chat = getChatById(chatId);
                if (!chat) return;
                
                const partnerUsername = getChatPartner(chat, userData.currentUser.username);
                const partnerUser = getUserByUsername(partnerUsername);
                
                if (searchTerm && !partnerUsername.toLowerCase().includes(searchTerm)) return;

                const lastMessage = chat.messages[chat.messages.length - 1];
                const activeClass = (chatId === userData.activeChatId) ? 'active' : '';
                
                const verifiedIcon = partnerUser && partnerUser.isVerified ? `<span class="verified-icon">${VERIFIED_ICON}</span>` : '';
                const premiumIcon = partnerUser && partnerUser.isPremium ? `<span class="premium-icon">${PREMIUM_ICON}</span>` : '';

                const chatCard = document.createElement('div');
                chatCard.className = `chat-card ${activeClass}`;
                chatCard.setAttribute('data-chat-id', chatId);
                chatCard.onclick = () => activateChat(chatId);
                
                chatCard.innerHTML = `
                    <span id="chat-card-avatar">üí¨</span>
                    <div class="chat-card-info" style="margin-left: 10px; flex-grow: 1; overflow: hidden;">
                        <div class="chat-partner-name" style="font-weight: bold;">${partnerUsername}${verifiedIcon}${premiumIcon}</div>
                        <div class="chat-last-message" style="font-size: 0.9rem; color: var(--accent-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${lastMessage ? lastMessage.text : 'New chat...'}</div>
                    </div>
                `;
                chatListEl.appendChild(chatCard);
            });
        }
        
        function renderMessages() {
            const messagesContainer = document.getElementById('messages-container');
            messagesContainer.innerHTML = '';
            
            if (!userData.activeChatId) {
                document.getElementById('chat-header').style.display = 'none';
                messagesContainer.innerHTML = '<p style="text-align: center; color: var(--accent-color);">Select a chat to start messaging.</p>';
                return;
            }

            document.getElementById('chat-header').style.display = 'flex';
            
            const activeChat = getChatById(userData.activeChatId);
            const partnerUsername = getChatPartner(activeChat, userData.currentUser.username);
            const partnerUser = getUserByUsername(partnerUsername);
            
            const verifiedIcon = partnerUser && partnerUser.isVerified ? ` <span class="verified-icon">${VERIFIED_ICON}</span>` : '';
            const premiumIcon = partnerUser && partnerUser.isPremium ? ` <span class="premium-icon">${PREMIUM_ICON}</span>` : '';
            
            document.getElementById('chat-partner-name').innerHTML = `${partnerUsername}${verifiedIcon}${premiumIcon}`;
            
            // Online/Offline Status Simulation
            const onlineStatusEl = document.getElementById('chat-online-status');
            if (partnerUsername !== SUPPORT_NAME && userData.isOnlineVisible) {
                onlineStatusEl.style.display = 'inline-block';
            } else {
                onlineStatusEl.style.display = 'none';
            }

            activeChat.messages.forEach(message => {
                const bubble = document.createElement('div');
                const isSelf = message.sender === userData.currentUser.username;
                
                bubble.className = `message-bubble ${isSelf ? 'message-self' : 'message-other'} ${userData.chatMessageSize}`;
                
                // Time Formatting
                const date = new Date(message.timestamp);
                const timeStr = `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
                
                bubble.innerHTML = `
                    ${message.text}
                    <span style="font-size: 0.7em; opacity: 0.7; display: block; text-align: ${isSelf ? 'right' : 'left'}; margin-top: 5px;">${timeStr}</span>
                `;
                messagesContainer.appendChild(bubble);
            });
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        function activateChat(chatId) {
            userData.activeChatId = chatId;
            renderChatList(); 
            renderMessages();
        }

        function updateMessageSize() {
            const bubbles = document.querySelectorAll('#messages-container .message-bubble');
            bubbles.forEach(bubble => {
                bubble.classList.remove('small', 'standard', 'large');
                bubble.classList.add(userData.chatMessageSize);
            });
        }

        // --- Event Handlers (Auth & App) ---
        
        document.getElementById('toggle-auth-btn').addEventListener('click', () => {
            const isLogin = document.getElementById('auth-title').textContent.includes('Log In');
            const titleEl = document.getElementById('auth-title');
            const emailInput = document.getElementById('auth-email');
            const submitBtn = document.getElementById('auth-submit-btn');

            if (isLogin) {
                titleEl.textContent = 'Sign Up for XDD Chat';
                emailInput.style.display = 'block';
                submitBtn.textContent = 'Sign Up';
                document.getElementById('toggle-auth-btn').textContent = 'Already have an account? Log In';
            } else {
                titleEl.textContent = 'Log In';
                emailInput.style.display = 'none';
                submitBtn.textContent = 'Log In';
                document.getElementById('toggle-auth-btn').textContent = 'Don\'t have an account? Sign Up';
            }
            document.getElementById('auth-error').textContent = '';
        });

        document.getElementById('auth-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const username = document.getElementById('auth-username').value;
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const errorEl = document.getElementById('auth-error');
            const isLogin = document.getElementById('auth-title').textContent.includes('Log In');
            errorEl.textContent = '';

            if (isLogin) {
                const user = getUserByUsername(username);
                if (user && user.password === password) {
                    if (user.isBannedUntil && user.isBannedUntil > Date.now()) {
                        const banDate = new Date(user.isBannedUntil).toLocaleString('en-US');
                        errorEl.textContent = `Your account is banned until ${banDate}.`;
                        return;
                    }
                    userData.currentUser = user;
                    loginSuccess();
                } else {
                    errorEl.textContent = 'Invalid username or password.';
                }
            } else {
                const usernameError = validateUsername(username);
                if (usernameError) {
                    errorEl.textContent = usernameError;
                    return;
                }
                
                if (getUserByUsername(username)) {
                    errorEl.textContent = 'Username is already taken.';
                    return;
                }

                const newUser = {
                    id: userData.nextUserId++,
                    email: email,
                    username: username,
                    password: password,
                    isVerified: false,
                    isPremium: false,
                    xddCoinBalance: 500,
                    chats: [1] 
                };
                userData.users.push(newUser);
                
                const supportChat = getChatById(1);
                if (supportChat) {
                    supportChat.participants.push(username); 
                }

                userData.currentUser = newUser;
                loginSuccess();
            }
        });
        
        function loginSuccess() {
            document.getElementById('auth-page').style.display = 'none';
            document.getElementById('main-app').style.display = 'flex';
            
            userData.activeChatId = userData.currentUser.chats[0];
            
            const defaultSizeEl = document.querySelector(`input[name="message-size"][value="${userData.chatMessageSize}"]`);
            if(defaultSizeEl) defaultSizeEl.checked = true;

            document.getElementById('online-status-toggle').checked = userData.isOnlineVisible;

            // Set the correct theme button state
            const currentTheme = document.body.classList.contains('light-theme') ? 'light' : 
                                 document.body.classList.contains('contrast-theme') ? 'contrast' : 'dark';
            applyTheme(currentTheme);

            initializeAdminSelect();
            updateUserInfoUI();
            renderChatList();
            renderMessages();
            showNotification(`Welcome, ${userData.currentUser.username}!`);
        }
        
        document.getElementById('logout-btn').addEventListener('click', () => {
            userData.currentUser = null;
            userData.activeChatId = null;
            document.getElementById('main-app').style.display = 'none';
            document.getElementById('settings-modal').style.display = 'none';
            document.getElementById('auth-page').style.display = 'flex';
            document.getElementById('auth-form').reset();
            document.getElementById('auth-error').textContent = '';
            
            document.getElementById('auth-title').textContent = 'Log In';
            document.getElementById('auth-email').style.display = 'none';
            document.getElementById('auth-submit-btn').textContent = 'Log In';
            document.getElementById('toggle-auth-btn').textContent = 'Don\'t have an account? Sign Up';
            showNotification('You have logged out.', 2000);
        });

        document.getElementById('open-settings-btn').addEventListener('click', () => {
            updateUserInfoUI(); 
            document.getElementById('settings-modal').style.display = 'flex';
        });

        document.getElementById('close-settings-btn').addEventListener('click', () => {
            document.getElementById('settings-modal').style.display = 'none';
        });

        document.getElementById('chat-search-input').addEventListener('input', renderChatList);
        
        document.querySelectorAll('.buy-coin-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const amount = parseInt(btn.getAttribute('data-amount'));
                userData.currentUser.xddCoinBalance += amount;
                updateUserInfoUI();
                showNotification(`Awarded ${amount} XDD Coin!`, 2000);
            });
        });
        
        document.getElementById('buy-premium-btn').addEventListener('click', () => {
            if (userData.currentUser.xddCoinBalance >= 999) {
                userData.currentUser.xddCoinBalance -= 999;
                userData.currentUser.isPremium = true;
                updateUserInfoUI();
                renderChatList();
                renderMessages();
                showNotification(`${PREMIUM_ICON} Premium Subscription Activated!`);
            } else {
                showNotification('‚ö†Ô∏è Not enough XDD Coin. 999 required.', 3000);
            }
        });

        document.querySelectorAll('.theme-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const theme = e.target.getAttribute('data-theme');
                applyTheme(theme);
            });
        });
        
        document.querySelectorAll('input[name="message-size"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                userData.chatMessageSize = e.target.value;
                updateMessageSize();
            });
        });
        
        document.getElementById('online-status-toggle').addEventListener('change', (e) => {
            userData.isOnlineVisible = e.target.checked;
            renderMessages();
            showNotification(`Online status is now ${userData.isOnlineVisible ? 'visible' : 'hidden'}.`, 2000);
        });

        function sendMessage() {
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            
            if (text === '' || !userData.activeChatId) return;

            const activeChat = getChatById(userData.activeChatId);
            if (!activeChat) return;

            const newMessage = {
                sender: userData.currentUser.username,
                text: text,
                timestamp: Date.now()
            };
            
            activeChat.messages.push(newMessage);
            input.value = '';
            
            renderChatList();
            renderMessages();
        }
        
        document.getElementById('send-message-btn').addEventListener('click', sendMessage);
        document.getElementById('message-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // --- Admin Panel Logic ---

        document.getElementById('admin-panel-trigger').addEventListener('click', () => {
            document.getElementById('admin-login-modal').style.display = 'flex';
        });

        document.getElementById('close-admin-login-btn').addEventListener('click', () => {
            document.getElementById('admin-login-modal').style.display = 'none';
        });
        
        document.getElementById('close-admin-panel-btn').addEventListener('click', () => {
            document.getElementById('admin-panel-modal').style.display = 'none';
        });

        document.getElementById('admin-login-btn').addEventListener('click', () => {
            const password = document.getElementById('admin-password-input').value;
            if (password === '1908') {
                document.getElementById('admin-login-modal').style.display = 'none';
                document.getElementById('admin-panel-modal').style.display = 'flex';
                document.getElementById('admin-password-input').value = '';
                initializeAdminSelect();
                renderSupportRequests();
                showNotification('Admin Panel Access Granted!', 2000);
            } else {
                showNotification('Invalid Admin Password!', 3000);
                document.getElementById('admin-password-input').value = '';
            }
        });

        function initializeAdminSelect() {
            const selectEl = document.getElementById('admin-user-select');
            selectEl.innerHTML = '';
            
            userData.users.filter(u => u.username !== SUPPORT_NAME).forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = user.username;
                selectEl.appendChild(option);
            });
            
            selectEl.addEventListener('change', displayAdminUserDetails);
            displayAdminUserDetails();
        }

        function displayAdminUserDetails() {
            const selectEl = document.getElementById('admin-user-select');
            const detailsEl = document.getElementById('admin-user-details');
            const selectedUserId = parseInt(selectEl.value);
            const user = getUserById(selectedUserId);
            
            if (!user) {
                detailsEl.innerHTML = '<p>Select a user.</p>';
                return;
            }

            const banStatus = user.isBannedUntil && user.isBannedUntil > Date.now() 
                ? `‚ùå Banned until: ${new Date(user.isBannedUntil).toLocaleString('en-US')}` 
                : '‚úÖ Not banned';
            
            detailsEl.innerHTML = `
                <h3>Details for ${user.username}</h3>
                <p>Email: ${user.email}</p>
                <p>XDD Balance: üí∞ ${user.xddCoinBalance}</p>
                <p>Premium: ${user.isPremium ? `${PREMIUM_ICON} Yes` : 'No'}</p>
                <p>Verification: ${user.isVerified ? `${VERIFIED_ICON} Yes` : 'No'}</p>
                <p>Ban Status: ${banStatus}</p>
            `;
            
            document.getElementById('admin-verify-btn').textContent = user.isVerified ? 'Remove Verification' : `Grant Verification ${VERIFIED_ICON}`;
        }

        document.getElementById('admin-verify-btn').addEventListener('click', () => {
            const selectEl = document.getElementById('admin-user-select');
            const selectedUserId = parseInt(selectEl.value);
            const user = getUserById(selectedUserId);
            
            if (user) {
                user.isVerified = !user.isVerified;
                displayAdminUserDetails();
                updateUserInfoUI();
                renderChatList();
                showNotification(`Verification for ${user.username} ${user.isVerified ? 'granted' : 'removed'}.`, 2000);
            }
        });

        document.getElementById('admin-award-coin-btn').addEventListener('click', () => {
            const selectEl = document.getElementById('admin-user-select');
            const amountInput = document.getElementById('admin-coin-amount');
            const selectedUserId = parseInt(selectEl.value);
            const user = getUserById(selectedUserId);
            const amount = parseInt(amountInput.value);
            
            if (user && amount > 0) {
                user.xddCoinBalance += amount;
                displayAdminUserDetails();
                if (user.id === userData.currentUser.id) updateUserInfoUI();
                amountInput.value = '';
                showNotification(`Awarded ${amount} Coin to ${user.username}.`, 2000);
            }
        });
        
        document.getElementById('admin-ban-btn').addEventListener('click', () => {
            const selectEl = document.getElementById('admin-user-select');
            const durationSelect = document.getElementById('admin-ban-duration');
            const selectedUserId = parseInt(selectEl.value);
            const user = getUserById(selectedUserId);
            const durationHours = parseInt(durationSelect.value);
            
            if (user) {
                const banUntil = Date.now() + durationHours * 60 * 60 * 1000;
                user.isBannedUntil = banUntil;
                displayAdminUserDetails();
                showNotification(`User ${user.username} banned for ${durationHours} hours.`, 3000);
            }
        });

        function renderSupportRequests() {
            const supportChat = getChatById(1);
            const supportRequestsList = document.getElementById('support-requests-list');
            supportRequestsList.innerHTML = '';
            
            const requests = supportChat.messages.filter(msg => 
                msg.sender !== SUPPORT_NAME && 
                !msg.isAnswered && 
                !msg.isRejected
            );

            if (requests.length === 0) {
                supportRequestsList.innerHTML = '<p style="text-align: center;">No pending requests.</p>';
                return;
            }

            requests.forEach((message, index) => {
                const requestItem = document.createElement('div');
                requestItem.className = 'support-request-item';
                requestItem.setAttribute('data-message-index', supportChat.messages.indexOf(message));
                requestItem.style.padding = '10px';
                requestItem.style.borderBottom = '1px solid rgba(255, 255, 255, 0.05)';
                requestItem.style.marginBottom = '10px';
                requestItem.style.background = 'rgba(0, 0, 0, 0.1)';
                requestItem.style.borderRadius = '8px';

                const userNameDisplay = message.sender || 'Unknown User';
                
                requestItem.innerHTML = `
                    <p style="font-weight: bold;">@${userNameDisplay} asks:</p>
                    <p style="margin-bottom: 10px;">${message.text}</p>
                    <div id="response-area-${index}">
                        <button class="neu-button admin-reply-btn" data-index="${index}" style="margin-right: 10px;">Reply</button>
                        <button class="neu-button red-button admin-reject-btn" data-index="${index}">Reject</button>
                    </div>
                `;
                supportRequestsList.appendChild(requestItem);
            });
            
            document.querySelectorAll('.admin-reply-btn').forEach(btn => btn.addEventListener('click', handleAdminReply));
            document.querySelectorAll('.admin-reject-btn').forEach(btn => btn.addEventListener('click', handleAdminReject));
        }
        
        function handleAdminReply(e) {
            const index = parseInt(e.target.getAttribute('data-index'));
            const requestItem = e.target.closest('.support-request-item');
            const messageIndexInChat = parseInt(requestItem.getAttribute('data-message-index'));
            const supportChat = getChatById(1);
            const originalMessage = supportChat.messages[messageIndexInChat];

            const responseArea = document.getElementById(`response-area-${index}`);
            responseArea.innerHTML = `
                <input type="text" id="admin-response-input-${index}" placeholder="Enter reply..." class="neu-input" style="width: 100%; margin-bottom: 10px;">
                <button class="neu-button accent-button admin-send-btn" data-message-index="${messageIndexInChat}">Send</button>
            `;

            document.querySelector(`.admin-send-btn[data-message-index="${messageIndexInChat}"]`).addEventListener('click', () => {
                const replyText = document.getElementById(`admin-response-input-${index}`).value.trim();
                if (replyText) {
                    addSupportResponse(originalMessage.sender, replyText, messageIndexInChat);
                    renderSupportRequests();
                    if (userData.currentUser && userData.currentUser.username === originalMessage.sender && userData.activeChatId === 1) {
                         renderMessages(); 
                    }
                }
            });
        }

        function handleAdminReject(e) {
            const requestItem = e.target.closest('.support-request-item');
            const messageIndexInChat = parseInt(requestItem.getAttribute('data-message-index'));
            const supportChat = getChatById(1);
            const originalMessage = supportChat.messages[messageIndexInChat];
            
            const rejectionText = 'Your request has been reviewed but was rejected.';
            addSupportResponse(originalMessage.sender, rejectionText, messageIndexInChat, true);
            renderSupportRequests();
            if (userData.currentUser && userData.currentUser.username === originalMessage.sender && userData.activeChatId === 1) {
                renderMessages(); 
            }
        }
        
        function addSupportResponse(targetUsername, text, originalMessageIndex, isRejected = false) {
            const supportChat = getChatById(1);
            
            supportChat.messages[originalMessageIndex].isAnswered = true;
            if (isRejected) supportChat.messages[originalMessageIndex].isRejected = true;

            const responseMessage = {
                sender: SUPPORT_NAME,
                text: text,
                timestamp: Date.now()
            };
            supportChat.messages.push(responseMessage);
            
            renderChatList();
            showNotification(`Response sent to ${targetUsername}.`, 2000);
        }

        // --- Initialization ---
        window.onload = () => {
            // 1. Show loading screen
            document.getElementById('loading-screen').style.display = 'flex';
            document.getElementById('auth-page').style.display = 'none';
            applyTheme('dark'); // Ensure initial dark theme is set

            // 2. Hide loading screen after 1.5 seconds and show auth page
            setTimeout(() => {
                document.getElementById('loading-screen').style.display = 'none';
                document.getElementById('auth-page').style.display = 'flex';
                
                // Set the correct theme button state after load
                const darkThemeBtn = document.querySelector('.theme-btn[data-theme="dark"]');
                if (darkThemeBtn) darkThemeBtn.classList.add('accent-button');

            }, 1500); 
        };

    </script>
</body>
</html>